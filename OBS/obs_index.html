
<!DOCTYPE html><html lang="en"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>OBS Billing</title>
<link rel="stylesheet" href="assets/style.css">
<script defer src="assets/app.js"></script>
</head><body>
<div class="container">
  <div class="header">
    <div class="brand"><span class="dot"></span> OBS Billing</div>
    <div class="nav">
      <a href="index.html">Home</a>
      <a href="obs_stock.html">Stock</a>
      <a href="obs_search.html">Search</a>
      <a href="#" id="logout">Logout</a>
    </div>
  </div>

  <div class="grid cols-3">
    <div class="card">
      <h3>Company / Shop</h3>
      <div class="grid">
        <input id="cname" placeholder="Company / Shop Name">
        <input id="caddr" placeholder="Address">
        <input id="cpan" placeholder="PAN Number">
        <button class="btn secondary" id="saveCompanyBtn">Save</button>
      </div>
    </div>
    <div class="card">
      <h3>Customer</h3>
      <div class="grid">
        <input id="custName" placeholder="Customer Name">
        <input id="custAddr" placeholder="Customer Address">
      </div>
    </div>
    <div class="card">
      <h3>Bill Info</h3>
      <div class="grid">
        <input id="billNo" placeholder="Bill No.">
        <div class="row"><span class="badge">Date & Time</span><div id="dtNow"></div></div>
        <div class="row"><span class="badge">Printed by</span><div id="printedBy"></div></div>
      </div>
    </div>
  </div>

  <div class="card">
    <h3>Add Items</h3>
    <div class="row">
      <input id="itemCode" placeholder="Item Code (scan or type)">
      <input id="itemName" placeholder="Item Name" disabled>
      <input id="itemRate" type="number" step="0.01" placeholder="Rate" disabled>
      <input id="itemQty" type="number" step="1" placeholder="Qty">
      <button class="btn" id="addItem">Add</button>
    </div>
    <p class="small">Item Code auto-fills name and rate from Stock. Qty defaults to 1.</p>
    <div style="overflow:auto; max-height:320px;margin-top:10px">
    <table class="table" id="cartTable">
      <thead><tr><th>Code</th><th>Name</th><th class="right">Rate</th><th class="right">Qty</th><th class="right">Amount</th><th class="right">Actions</th></tr></thead>
      <tbody></tbody>
    </table>
    </div>
  </div>

  <div class="grid cols-3">
    <div class="card">
      <h3>Totals</h3>
      <div class="grid">
        <div class="row"><span>Subtotal</span><strong class="right" id="subtotal">0.00</strong></div>
        <div class="row"><span>Discount %</span><input id="discount" type="number" step="0.01" value="0"></div>
        <div class="row"><span>VAT %</span><input id="vat" type="number" step="0.01" value="0"></div>
        <div class="row"><span>Grand Total</span><strong class="right" id="grand">0.00</strong></div>
      </div>
    </div>
    <div class="card">
      <h3>Payment</h3>
      <div class="grid">
        <select id="payMethod">
          <option value="cash">Cash</option>
          <option value="online">Online Payment</option>
        </select>
        <div id="onlineBox" class="hidden">
          <img src="images/qr.jpg" alt="QR" style="max-width:220px;border-radius:12px;border:1px solid #233045">
          <p class="small">Scan to pay</p>
        </div>
        <div id="cashBox">
          <div class="row"><span>Total Amount</span><strong class="right" id="cashTotal">0.00</strong></div>
          <div class="row"><span>Amount Given</span><input id="given" type="number" step="0.01"></div>
          <div class="row"><span>Change</span><strong class="right" id="change">0.00</strong></div>
        </div>
      </div>
    </div>
    <div class="card">
      <h3>Actions</h3>
      <div class="grid">
        <button class="btn" id="printBill">Print Bill</button>
        <button class="btn secondary" id="resetBill">New Bill</button>
      </div>
      <p class="small">Print shows CUSTOMER COPY. A SELLER COPY .txt will auto-download.</p>
    </div>
  </div>

  <div class="card no-print">
    <h3>Bill Preview</h3>
    <div id="billArea" class="print-bill-page">
      <div class="bill-title">Invoice <span id="copyType" style="font-size:10pt;font-weight:600">(Customer Copy)</span></div>
      <div class="bill-meta" id="billHeader"></div>
      <table class="bill-table" id="billItems">
        <thead><tr><th>#</th><th>Item</th><th class="right">Rate</th><th class="right">Qty</th><th class="right">Amt</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="bill-footer">
        <div>
          <div id="billTotals"></div>
          <div id="billPayment"></div>
        </div>
        <div style="text-align:right">
          <div id="billTime"></div>
          <div id="billPrintedBy" style="margin-top:6px;font-weight:700"></div>
        </div>
      </div>
    </div>
  </div>

  <footer>Â© <span id="y"></span> OBS. All rights reserved.</footer>
</div>
<script>
const session = requireAuth();
document.getElementById('y').textContent = new Date().getFullYear();
document.getElementById('logout').onclick = logout;
document.getElementById('printedBy').textContent = session.displayName + ' (' + session.username + ')';

// Company fields
const co = getCompanyDetails();
cname.value = co.name||''; caddr.value = co.address||''; cpan.value = co.pan||'';
saveCompanyBtn.onclick = ()=>{ saveCompanyDetails({name:cname.value.trim(), address:caddr.value.trim(), pan:cpan.value.trim()}); toast('Company saved','success'); renderBill(); };

// Date-time live
function tick(){ dtNow.textContent = nowStamp(); billTime.textContent = 'Date: ' + nowStamp(); }
setInterval(tick, 1000); tick();

// Cart state
let cart = []; // {code,name,rate,qty}
function addToCart(item){
  const idx = cart.findIndex(x=>x.code===item.code);
  if(idx>=0){ cart[idx].qty += item.qty; } else { cart.push(item); }
  renderCart(); computeTotals(); renderBill();
}
function removeFromCart(code){ cart = cart.filter(x=>x.code!==code); renderCart(); computeTotals(); renderBill(); }
function renderCart(){
  const tbody = document.querySelector('#cartTable tbody'); tbody.innerHTML='';
  cart.forEach((it, i)=>{
    const amt = it.rate * it.qty;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${it.code}</td><td>${it.name}</td><td class="right">${money(it.rate)}</td>
      <td class="right"><input data-qty="${it.code}" type="number" min="1" value="${it.qty}" style="width:90px"></td>
      <td class="right">${money(amt)}</td>
      <td class="right"><button class="btn danger" data-del="${it.code}">Remove</button></td>`;
    tbody.appendChild(tr);
  });
}
document.querySelector('#cartTable').oninput = (e)=>{
  const code = e.target.getAttribute('data-qty'); if(!code) return;
  const v = Math.max(1, Number(e.target.value||1));
  const it = cart.find(x=>x.code===code); if(it){ it.qty = v; renderCart(); computeTotals(); renderBill(); }
};
document.querySelector('#cartTable').onclick = (e)=>{
  const code = e.target.getAttribute('data-del'); if(!code) return;
  removeFromCart(code);
};

// Item Code auto-fill
itemCode.oninput = ()=>{
  const it = findStockByCode(itemCode.value.trim());
  if(it){ itemName.value = it.name; itemRate.value = it.rate; } else { itemName.value=''; itemRate.value=''; }
};
addItem.onclick = ()=>{
  const code = itemCode.value.trim();
  const it = findStockByCode(code);
  if(!it){ toast('Unknown Item Code','error'); return; }
  const qty = Math.max(1, Number(itemQty.value||1));
  addToCart({code: it.code, name: it.name, rate: Number(it.rate), qty});
  itemCode.value=''; itemName.value=''; itemRate.value=''; itemQty.value='';
};

// Totals
function computeTotals(){
  const sub = cart.reduce((s,it)=> s + it.rate*it.qty, 0);
  subtotal.textContent = money(sub);
  const discP = Math.max(0, Number(discount.value||0));
  const vatP  = Math.max(0, Number(vat.value||0));
  const afterDisc = sub - (sub * discP/100); // discount first
  const afterVat  = afterDisc + (afterDisc * vatP/100); // then VAT
  grand.textContent = money(afterVat);
  cashTotal.textContent = money(afterVat);
  const givenAmt = Number(given.value||0);
  change.textContent = money(givenAmt - afterVat);
}
discount.oninput = computeTotals; vat.oninput = computeTotals; given.oninput = computeTotals;

// Payment method toggle
payMethod.onchange = ()=>{
  if(payMethod.value==='online'){ onlineBox.classList.remove('hidden'); cashBox.classList.add('hidden'); }
  else { onlineBox.classList.add('hidden'); cashBox.classList.remove('hidden'); }
};
payMethod.dispatchEvent(new Event('change'));

// Bill render
function renderBill(){
  // header
  const company = getCompanyDetails();
  billHeader.innerHTML = `<div><strong>${company.name||''}</strong><br>${company.address||''}<br>PAN: ${company.pan||''}</div>
  <div>Bill No: ${billNo.value||''}<br>Customer: ${custName.value||''}<br>Address: ${custAddr.value||''}</div>`;
  // items
  const tbody = document.querySelector('#billItems tbody'); tbody.innerHTML='';
  cart.forEach((it,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${it.name}</td><td class="right">${money(it.rate)}</td><td class="right">${it.qty}</td><td class="right">${money(it.rate*it.qty)}</td>`;
    tbody.appendChild(tr);
  });
  const sub = cart.reduce((s,it)=> s + it.rate*it.qty, 0);
  const discP = Math.max(0, Number(discount.value||0));
  const vatP  = Math.max(0, Number(vat.value||0));
  const afterDisc = sub - (sub * discP/100);
  const afterVat  = afterDisc + (afterDisc * vatP/100);
  billTotals.innerHTML = `Subtotal: ${money(sub)} | Discount ${discP}% | VAT ${vatP}% | Grand: <strong>${money(afterVat)}</strong>`;
  const pay = payMethod.value==='online' ? 'Online Payment' : `Cash (Given ${money(Number(given.value||0))}, Change ${change.textContent})`;
  billPayment.textContent = 'Payment: ' + pay;
  billPrintedBy.textContent = 'Printed by: ' + session.displayName + ' ('+session.username+')';
}
renderBill();

// Print bill => save txn, download seller copy txt, then print customer copy
printBill.onclick = ()=>{
  if(cart.length===0){ toast('Add at least one item','error'); return; }
  const txnId = uid();
  const createdAt = Date.now();
  const company = getCompanyDetails();
  const sub = cart.reduce((s,it)=> s + it.rate*it.qty, 0);
  const discP = Math.max(0, Number(discount.value||0));
  const vatP  = Math.max(0, Number(vat.value||0));
  const afterDisc = sub - (sub * discP/100);
  const afterVat  = afterDisc + (afterDisc * vatP/100);
  const txn = {
    txnId, createdAt, datetime: nowStamp(),
    user: session, company,
    customer: {name: custName.value.trim(), address: custAddr.value.trim()},
    billNo: billNo.value.trim(),
    items: cart.slice(),
    subtotal: sub, discountP: discP, vatP: vatP, grand: afterVat,
    payMethod: payMethod.value, given: Number(given.value||0), change: Number(change.textContent)
  };
  saveTxn(txn);

  // Build SELLER COPY txt
  let lines = [];
  lines.push('SELLER COPY');
  lines.push(`${company.name||''}`);
  lines.push(`${company.address||''}`);
  lines.push(`PAN: ${company.pan||''}`);
  lines.push(`Date/Time: ${txn.datetime}`);
  lines.push(`Bill No: ${txn.billNo||''}`);
  lines.push(`Transaction ID: ${txn.txnId}`);
  lines.push(`Customer: ${txn.customer.name||''} | ${txn.customer.address||''}`);
  lines.push('----------------------------------------');
  txn.items.forEach((it,i)=>{
    lines.push(`${i+1}. ${it.name}  x${it.qty}  @${money(it.rate)}  = ${money(it.rate*it.qty)}`);
  });
  lines.push('----------------------------------------');
  lines.push(`Subtotal: ${money(txn.subtotal)}`);
  lines.push(`Discount ${txn.discountP}%`);
  lines.push(`VAT ${txn.vatP}%`);
  lines.push(`Grand Total: ${money(txn.grand)}`);
  lines.push(`Payment: ${txn.payMethod==='online'?'Online Payment':('Cash | Given: '+money(txn.given)+' | Change: '+money(txn.change))}`);
  lines.push(`Printed by: ${session.displayName} (${session.username})`);
  downloadText(`${txnId}.txt`, lines.join('\n'));

  // Print CUSTOMER COPY (label already set)
  window.print();
  toast('Bill saved & downloaded','success');
};
resetBill.onclick = ()=>{ cart=[]; discount.value=0; vat.value=0; given.value=''; renderCart(); computeTotals(); renderBill(); };

// Live recompute on edit fields
['custName','custAddr','billNo','discount','vat','given'].forEach(id=>{
  const el = document.getElementById(id);
  el.addEventListener('input', ()=>{ computeTotals(); renderBill(); });
});
computeTotals();
</script>
</body></html>
